<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Offers - Credit Card Rewards Comparison</title>
    <meta name="description" content="Find and compare the best credit card offers from American Express, Chase, Citi, Wells Fargo, and US Bank">
    <link rel="stylesheet" href="css/styles.css">
    <!-- Favicon -->
    <link rel="icon" href="images/icon.png" type="image/png">
    <style>
        .navigation {
            text-align: center;
            margin: 1rem 0;
        }
        
        .navigation a {
            color: #4CAF50;
            text-decoration: none;
            margin: 0 1rem;
            font-weight: bold;
        }
        
        .navigation a:hover {
            text-decoration: underline;
        }
        
        .community-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
            text-align: center;
        }
        
        .community-section h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        .community-section p {
            margin-bottom: 1rem;
        }
        
        .community-section a {
            color: #4CAF50;
            font-weight: bold;
            text-decoration: none;
        }
        
        .community-section a:hover {
            text-decoration: underline;
        }
        
        /* Checkbox filter styles */
        .checkbox-filter {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin: 1rem 0;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .checkbox-filter-label {
            margin-right: 1rem;
            font-weight: bold;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            margin-right: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .checkbox-option input {
            margin-right: 0.5rem;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .checkbox-option label {
            cursor: pointer;
        }
        
        .filter-actions {
            margin-left: auto;
        }
        
        .filter-actions button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }
        
        .filter-actions button:hover {
            background-color: #45a049;
        }
        
        /* No results message */
        .no-results {
            text-align: center;
            padding: 2rem;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin: 2rem 0;
            color: #666;
        }
        
        .no-results h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        /* Make checkboxes more prominent */
        .checkbox-option input[type="checkbox"] {
            accent-color: #4CAF50;
        }
        
        @media (max-width: 768px) {
            .checkbox-filter {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .checkbox-option {
                margin-top: 0.5rem;
            }
            
            .filter-actions {
                margin-left: 0;
                margin-top: 1rem;
                width: 100%;
                display: flex;
                justify-content: flex-end;
            }
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J16DNE447G"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-J16DNE447G');
    </script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
              <img src="images/icon.png" alt="Merchant Offers Logo" class="logo-icon">
              <h1>Merchant Offers</h1>
            </div>
            <p class="tagline">Find the best credit card rewards across major banks</p>
        </header>
        
        <div class="navigation">
            <a href="index.html" class="active">Home</a>
            <a href="help.html">Support</a>
            <a href="privacy.html">Privacy Policy</a>
        </div>
        
        <div class="disclaimer">
            <p><strong>Disclaimer:</strong> This site provides a guide to potentially available credit card offers. Please check your card issuer's app or website for the most current offers available to you. Offers may vary based on your account and some offers shown here may have expired. We update this information monthly but cannot guarantee accuracy.</p>
        </div>
        
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search for merchants or offers...">
        </div>
        
        <div class="checkbox-filter">
            <span class="checkbox-filter-label">Filter by card:</span>
            
            <div class="checkbox-option">
                <input type="checkbox" id="amex" value="American Express" checked>
                <label for="amex">Amex</label>
            </div>
            
            <div class="checkbox-option">
                <input type="checkbox" id="chase" value="Chase" checked>
                <label for="chase">Chase</label>
            </div>
            
            <div class="checkbox-option">
                <input type="checkbox" id="citi" value="Citi" checked>
                <label for="citi">Citi</label>
            </div>
            
            <div class="checkbox-option">
                <input type="checkbox" id="wellsFargo" value="Wells Fargo" checked>
                <label for="wellsFargo">Wells Fargo</label>
            </div>
            
            <div class="checkbox-option">
                <input type="checkbox" id="usBank" value="US Bank" checked>
                <label for="usBank">US Bank</label>
            </div>
            
            <div class="filter-actions">
                <button id="selectAll">Select All</button>
                <button id="clearAll">Clear All</button>
            </div>
        </div>
        
        <div id="offersContainer">
            <!-- Offers will be populated here by JavaScript -->
            <div class="loading">Loading offers...</div>
        </div>
        
        <!-- No results message (initially hidden) -->
        <div id="noResults" class="no-results" style="display: none;">
            <h3>No Offers Found</h3>
            <p>No offers match your current filter settings. Try selecting more card types or adjusting your search.</p>
        </div>
        
        <div class="community-section">
            <h3>Help Us Improve</h3>
            <p>Know of an offer we're missing? Found an outdated deal? Having trouble with our extension?</p>
            <p><a href="help.html">Visit our support page</a> to submit new offers, report outdated ones, or get help with any issues.</p>
        </div>
        
        <div class="extension-promo">
            <div class="promo-content">
                <div class="promo-text">
                    <h3>Get the Chrome Extension!</h3>               
                    <p>Get notified of available offers when you visit merchant websites!                 
                    <a href="#" class="promo-button" id="extensionLink">Coming Soon!</a>
                    </p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>&copy; 2025 MerchantOffers.online - Updated monthly with the latest card offers</p>
            <p class="disclaimer-footer">This site is for informational purposes only. All offers are subject to change and may not be available to all cardholders.</p>
        </footer>
    </div>

    <script>
        // Global variables
        let allOffers = [];
        // Handle both local and GitHub Pages environments
        const dataUrl = location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
            ? 'data/credit_card_offers.json' 
            : '/data/credit_card_offers.json';

        // Fetch offers data from JSON file
        async function loadOffers() {
          try {
              console.log("Attempting to load data from:", dataUrl);
              
              const response = await fetch(dataUrl);
              if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }
              
              const data = await response.json();
              console.log(`Successfully loaded ${data.length} offers`);
              
              allOffers = data;
              applyFiltersAndRender();
              
              // Remove loading indicator
              document.querySelector('.loading')?.remove();
          } catch (error) {
              console.error("Error loading offers:", error);
              const errorMsg = `Error loading offers: ${error.message}. Please try again later.`;
              document.querySelector('.loading').textContent = errorMsg;
              
              // Add technical details for debugging (only visible in console)
              console.log("Technical details:");
              console.log("- Current URL:", window.location.href);
              console.log("- Data URL attempted:", dataUrl);
              console.log("- Error object:", error);
          }
        }

        // Group offers by merchant name
        function organizeOffers(offers) {
            const merchantGroups = {};
            
            // Group by merchant
            offers.forEach(offer => {
                if (!merchantGroups[offer.merchant]) {
                    merchantGroups[offer.merchant] = [];
                }
                
                merchantGroups[offer.merchant].push(offer);
            });
            
            return merchantGroups;
        }

        // Clean offer text to remove dates
        function cleanOfferText(text) {
            // Remove date patterns
            text = text.replace(/\d{1,2}\/\d{1,2}\/\d{2,4}/g, ''); // Remove dates like 03/31/25
            text = text.replace(/expires\s+\w+\s+\d{1,2}(st|nd|rd|th)?,?\s+\d{4}/i, ''); // Expires March 31st, 2025
            text = text.replace(/expires\s+in\s+\d+\s+days?/i, ''); // Expires in 10 days
            text = text.replace(/expires\s+\w+/i, ''); // Expires today
            
            // Clean up any leftover text
            text = text.replace(/valid\s+until.*/i, '');
            text = text.replace(/through.*/i, '');
            
            // Trim whitespace and punctuation at the end
            text = text.replace(/[.,;:]\s*$/, '');
            
            return text.trim();
        }

        // Sort offers by value (best first)
        function sortOffersByValue(offers) {
            return [...offers].sort((a, b) => {
                const aValue = getOfferValue(a.offer);
                const bValue = getOfferValue(b.offer);
                return bValue - aValue;
            });
        }

        // Get numerical value from an offer string
        function getOfferValue(offerText) {
            // Extract percentage
            const percentMatch = offerText.match(/(\d+)%/);
            if (percentMatch) {
                return parseInt(percentMatch[1]);
            }
            
            // Extract dollar amount
            const dollarMatch = offerText.match(/\$(\d+)/);
            if (dollarMatch) {
                return parseInt(dollarMatch[1]);
            }
            
            return 0;
        }

        // Find the best offer for a merchant
        function findBestOffer(offers) {
            if (!offers || offers.length === 0) {
                return '';
            }
            
            // Sort offers by value
            const sortedOffers = sortOffersByValue(offers);
            
            // Return the highest value offer
            return sortedOffers[0].offer;
        }

        // Filter and render offers based on current checkboxes and search
        function applyFiltersAndRender() {
            // Get selected card values
            const selectedCards = Array.from(document.querySelectorAll('.checkbox-option input:checked'))
                .map(checkbox => checkbox.value);
            
            // Get search term
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            // Filter by selected cards - if no cards selected, show no results
            let filteredOffers = [];
            
            if (selectedCards.length > 0) {
                filteredOffers = allOffers.filter(offer => selectedCards.includes(offer.card));
                
                // Then filter by search term
                if (searchTerm) {
                    filteredOffers = filteredOffers.filter(offer => 
                        offer.merchant.toLowerCase().includes(searchTerm) ||
                        offer.offer.toLowerCase().includes(searchTerm)
                    );
                }
            }
            
            // Show/hide no results message
            if (filteredOffers.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('offersContainer').innerHTML = ''; // Clear offers container
            } else {
                document.getElementById('noResults').style.display = 'none';
                renderOffers(filteredOffers);
            }
        }

        // Render offers with improved display
        function renderOffers(offers) {
            const merchantGroups = organizeOffers(offers);
            const container = document.getElementById('offersContainer');
            container.innerHTML = '';
            
            const merchantList = document.createElement('div');
            merchantList.className = 'merchant-list';
            
            // Create a card for each merchant
            Object.keys(merchantGroups).sort().forEach(merchant => {
                const merchantOffers = merchantGroups[merchant];
                
                const merchantCard = document.createElement('div');
                merchantCard.className = 'merchant-card';
                
                // Create merchant header and toggle button
                const merchantHeader = document.createElement('div');
                merchantHeader.className = 'merchant-header';
                merchantHeader.innerHTML = `
                    <div class="merchant-name">${merchant}</div>
                    <button class="toggle-btn">View Offers</button>
                `;
                
                // Find best offer to display on the card
                let bestOffer = findBestOffer(merchantOffers);
                const offerPreview = document.createElement('div');
                offerPreview.className = 'offer-preview';
                offerPreview.innerHTML = `<span class="best-offer">${cleanOfferText(bestOffer)}</span>`;
                
                // Create offer details section
                const offerDetails = document.createElement('div');
                offerDetails.className = 'offer-details';
                
                // Sort offers by value (best first)
                const sortedOffers = sortOffersByValue(merchantOffers);
                
                // Add each card's offer for this merchant
                sortedOffers.forEach(offer => {
                    const offerRow = document.createElement('div');
                    offerRow.className = 'offer-row';
                    offerRow.setAttribute('data-card', offer.card);
                    
                    // Don't show expiration dates, just the offer
                    offerRow.innerHTML = `
                        <div class="card-name">${offer.card}</div>
                        <div class="offer-value">${cleanOfferText(offer.offer)}</div>
                    `;
                    offerDetails.appendChild(offerRow);
                });
                
                // Add toggle functionality
                merchantHeader.querySelector('.toggle-btn').addEventListener('click', function() {
                    const isVisible = offerDetails.style.display === 'block';
                    offerDetails.style.display = isVisible ? 'none' : 'block';
                    this.textContent = isVisible ? 'View Offers' : 'Hide Offers';
                });
                
                // Assemble merchant card
                merchantCard.appendChild(merchantHeader);
                merchantCard.appendChild(offerPreview);
                merchantCard.appendChild(offerDetails);
                merchantList.appendChild(merchantCard);
            });
            
            container.appendChild(merchantList);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Setup checkbox filtering
            const checkboxes = document.querySelectorAll('.checkbox-option input');
            const selectAllBtn = document.getElementById('selectAll');
            const clearAllBtn = document.getElementById('clearAll');
            
            // Add event listeners to checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFiltersAndRender);
            });
            
            // Select all button
            selectAllBtn.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                applyFiltersAndRender();
            });
            
            // Clear all button
            clearAllBtn.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                applyFiltersAndRender();
            });
            
            // Set up search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                // Debounce search to improve performance
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    applyFiltersAndRender();
                }, 300);
            });
            
            // Extension link
            document.getElementById('extensionLink').addEventListener('click', function(e) {
                e.preventDefault();
                // Replace with your actual Chrome Web Store URL when available
                alert('Coming soon to the Chrome Web Store!');
                // Uncomment when you have the Chrome Web Store URL:
                // window.open('https://chrome.google.com/webstore/detail/your-extension-id', '_blank');
            });
            
            // Load offers
            loadOffers();
        });
    </script>
</body>
</html>